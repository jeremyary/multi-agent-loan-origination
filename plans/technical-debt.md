# Technical Debt

Tracked items to address before production or during hardening phases.

## Rate limiting on public endpoints

The public API (`/api/public/products`, `/api/public/calculate-affordability`) requires no authentication. No rate limiting exists on any endpoint. Before any non-local deployment, add rate limiting to prevent abuse of unauthenticated routes and brute-force attempts on auth endpoints.

## Dev Postgres port hardcoded to 5433

All connection strings default to port 5433 to avoid conflicts with existing local Postgres instances. This is scattered across `compose.yml`, `alembic.ini`, `database.py`, `admin.py`, and `config.py`. Should be centralized to a single env var (`DATABASE_URL`) with all consumers reading from config rather than hardcoding.

## Alembic migration hand-written

The first migration (`fe5adcef3769_add_domain_models.py`) was written manually rather than autogenerated via `alembic revision --autogenerate`. The revision ID is fabricated. Future migrations should use the Alembic CLI to generate proper revision chains.

## SQLAlchemy deprecated API usage

`packages/db/src/db/database.py` uses `sqlalchemy.ext.declarative.declarative_base()` which is deprecated in SQLAlchemy 2.0. Should migrate to `sqlalchemy.orm.DeclarativeBase`.

## Pydantic v2 deprecated config style

`packages/api/src/core/config.py` uses class-based `Config` inner class which is deprecated in Pydantic v2. Should migrate to `model_config = ConfigDict(...)`.

## Admin panel uses separate sync engine

`packages/api/src/admin.py` creates its own `sqlalchemy.create_engine` with a hardcoded connection string, separate from the async engine used by the rest of the app. SQLAdmin requires a sync engine, but the URL should come from config.

## JWKS key rotation lacks integration test

The cache-bust-on-kid-mismatch logic in `middleware/auth.py` (lines 60-77) handles Keycloak key rotation by refetching JWKS when a token's `kid` isn't found in the cached key set. This path has no automated test coverage. Unit testing it requires heavy mocking of the JWKS fetch machinery. Add an integration test once Keycloak is running in CI that actually rotates keys and verifies tokens still validate.

## Ruff config extends nonexistent shared config

`packages/db/pyproject.toml` has `extend = "../../configs/ruff/pyproject.toml"` but that file doesn't exist. Ruff silently ignores this but it should either be created or the extend removed.
