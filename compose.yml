# This project was developed with assistance from AI tools.
#
# Summit Cap Financial -- local development stack
#
# Profiles:
#   (none)          postgres + minio + api + ui
#   auth            + keycloak
#   ai              + llamastack
#   observability   + redis, clickhouse, langfuse-web, langfuse-worker
#   full            everything
#
# Usage:
#   podman-compose up -d                          # minimal stack
#   podman-compose --profile full up -d           # full stack
#   make run                                      # alias for full

x-langfuse-environment: &langfuse-env
  DATABASE_URL: postgresql://user:password@summit-cap-db:5432/langfuse
  NEXTAUTH_URL: http://localhost:3001
  NEXTAUTH_SECRET: mysecret
  SALT: mysalt
  ENCRYPTION_KEY: "0000000000000000000000000000000000000000000000000000000000000000"
  TELEMETRY_ENABLED: "false"
  LANGFUSE_INIT_ORG_ID: summit-cap
  LANGFUSE_INIT_ORG_NAME: Summit Cap Financial
  LANGFUSE_INIT_PROJECT_ID: summit-cap-dev
  LANGFUSE_INIT_PROJECT_NAME: Summit Cap Dev
  LANGFUSE_INIT_PROJECT_PUBLIC_KEY: pk-lf-dev-public
  LANGFUSE_INIT_PROJECT_SECRET_KEY: sk-lf-dev-secret
  LANGFUSE_INIT_USER_EMAIL: admin@summitcap.dev
  LANGFUSE_INIT_USER_NAME: Admin
  LANGFUSE_INIT_USER_PASSWORD: password
  CLICKHOUSE_MIGRATION_URL: clickhouse://clickhouse:clickhouse@clickhouse:9000/default
  CLICKHOUSE_URL: http://clickhouse:8123
  CLICKHOUSE_USER: clickhouse
  CLICKHOUSE_PASSWORD: clickhouse
  CLICKHOUSE_CLUSTER_ENABLED: "false"
  REDIS_HOST: redis
  REDIS_PORT: "6379"
  REDIS_AUTH: myredissecret
  LANGFUSE_S3_EVENT_UPLOAD_BUCKET: langfuse
  LANGFUSE_S3_EVENT_UPLOAD_REGION: us-east-1
  LANGFUSE_S3_EVENT_UPLOAD_ACCESS_KEY_ID: minio
  LANGFUSE_S3_EVENT_UPLOAD_SECRET_ACCESS_KEY: miniosecret
  LANGFUSE_S3_EVENT_UPLOAD_ENDPOINT: http://minio:9000
  LANGFUSE_S3_EVENT_UPLOAD_FORCE_PATH_STYLE: "true"
  LANGFUSE_S3_MEDIA_UPLOAD_BUCKET: langfuse
  LANGFUSE_S3_MEDIA_UPLOAD_REGION: us-east-1
  LANGFUSE_S3_MEDIA_UPLOAD_ACCESS_KEY_ID: minio
  LANGFUSE_S3_MEDIA_UPLOAD_SECRET_ACCESS_KEY: miniosecret
  LANGFUSE_S3_MEDIA_UPLOAD_ENDPOINT: http://minio:9000
  LANGFUSE_S3_MEDIA_UPLOAD_FORCE_PATH_STYLE: "true"

services:
  # ------------------------------------------------------------------ always --
  summit-cap-db:
    image: docker.io/pgvector/pgvector:pg16
    labels:
      com.quickstart.package: db
    environment:
      POSTGRES_DB: summit-cap
      POSTGRES_USER: user
      POSTGRES_PASSWORD: password
    ports:
      - "5433:5432"
    volumes:
      - summit_cap_postgres_data:/var/lib/postgresql/data
      - ./config/postgres/init-databases.sh:/docker-entrypoint-initdb.d/init-databases.sh:ro
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U user -d summit-cap"]
      interval: 5s
      timeout: 5s
      retries: 5

  summit-cap-api:
    build:
      context: .
      dockerfile: packages/api/Containerfile
    labels:
      com.quickstart.package: api
    ports:
      - "8000:8000"
    depends_on:
      summit-cap-db:
        condition: service_healthy
      minio:
        condition: service_healthy
    environment:
      DATABASE_URL: postgresql+asyncpg://user:password@summit-cap-db:5432/summit-cap
      COMPLIANCE_DATABASE_URL: postgresql+asyncpg://compliance_app:compliance_pass@summit-cap-db:5432/summit-cap
      AUTH_DISABLED: "true"
      KEYCLOAK_URL: http://keycloak:8080
      LLM_BASE_URL: "${LLM_BASE_URL:-http://host.docker.internal:1234/v1}"
      LLM_API_KEY: "${LLM_API_KEY:-not-needed}"
      LLM_MODEL_FAST: "${LLM_MODEL_FAST:-}"
      LLM_MODEL_CAPABLE: "${LLM_MODEL_CAPABLE:-}"
      SAFETY_MODEL: "${SAFETY_MODEL:-}"
      S3_ENDPOINT: http://minio:9000
      S3_ACCESS_KEY: minio
      S3_SECRET_KEY: miniosecret
      S3_BUCKET: documents
      LANGFUSE_SECRET_KEY: "${LANGFUSE_SECRET_KEY:-sk-lf-dev-secret}"
      LANGFUSE_PUBLIC_KEY: "${LANGFUSE_PUBLIC_KEY:-pk-lf-dev-public}"
      LANGFUSE_HOST: "${LANGFUSE_HOST:-http://langfuse-web:3000}"
    volumes:
      - ./config:/app/config:ro
    healthcheck:
      test: ["CMD-SHELL", "python -c \"import urllib.request; urllib.request.urlopen('http://localhost:8000/health/')\""]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  summit-cap-ui:
    build:
      context: .
      dockerfile: packages/ui/Containerfile
    labels:
      com.quickstart.package: ui
    ports:
      - "3000:8080"
    depends_on:
      summit-cap-api:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "wget --spider -q http://127.0.0.1:8080/ || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s

  # -------------------------------------------------------------------- auth --
  keycloak:
    image: quay.io/keycloak/keycloak:26.0
    profiles: ["auth", "full"]
    labels:
      com.quickstart.package: auth
    command: start-dev --import-realm
    environment:
      KC_BOOTSTRAP_ADMIN_USERNAME: admin
      KC_BOOTSTRAP_ADMIN_PASSWORD: admin
      KC_HEALTH_ENABLED: "true"
    ports:
      - "8080:8080"
    volumes:
      - ./config/keycloak/summit-cap-realm.json:/opt/keycloak/data/import/summit-cap-realm.json:ro
    healthcheck:
      test: ["CMD", "bash", "-c", "{ printf 'HEAD /health/ready HTTP/1.0\\r\\n\\r\\n' >&0; grep 'HTTP/1.0 200'; } 0<>/dev/tcp/localhost/9000"]
      interval: 10s
      timeout: 5s
      retries: 12
      start_period: 30s

  # ---------------------------------------------------------------------- ai --
  llamastack:
    image: docker.io/llamastack/distribution-starter:latest
    profiles: ["ai", "full"]
    labels:
      com.quickstart.package: ai
    ports:
      - "8321:8321"
    volumes:
      - ./config/llamastack/run.yaml:/app/run.yaml:ro
    environment:
      RUN_CONFIG_PATH: /app/run.yaml
      LLM_BASE_URL: "${LLM_BASE_URL:-http://host.docker.internal:1234/v1}"
      LLM_API_KEY: "${LLM_API_KEY:-not-needed}"
    healthcheck:
      test: ["CMD-SHELL", "curl -sf http://localhost:8321/v1/health || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 15s

  # ----------------------------------------------------------- observability --
  redis:
    image: docker.io/redis:7-alpine
    profiles: ["observability", "full"]
    labels:
      com.quickstart.package: observability
    command: --requirepass myredissecret --maxmemory-policy noeviction
    ports:
      - "6380:6379"
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "myredissecret", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5

  clickhouse:
    image: docker.io/clickhouse/clickhouse-server:24
    profiles: ["observability", "full"]
    labels:
      com.quickstart.package: observability
    user: "101:101"
    environment:
      CLICKHOUSE_DB: default
      CLICKHOUSE_USER: clickhouse
      CLICKHOUSE_PASSWORD: clickhouse
    ports:
      - "8123:8123"
      - "9000:9000"
    volumes:
      - langfuse_clickhouse_data:/var/lib/clickhouse
      - langfuse_clickhouse_logs:/var/log/clickhouse-server
    healthcheck:
      test: ["CMD-SHELL", "wget --spider -q http://localhost:8123/ping || exit 1"]
      interval: 5s
      timeout: 3s
      retries: 5

  minio:
    image: docker.io/minio/minio:latest
    labels:
      com.quickstart.package: storage
    entrypoint: sh
    command: -c 'mkdir -p /data/langfuse /data/documents && exec minio server --address ":9000" --console-address ":9001" /data'
    environment:
      MINIO_ROOT_USER: minio
      MINIO_ROOT_PASSWORD: miniosecret
    ports:
      - "9090:9000"
      - "9091:9001"
    volumes:
      - langfuse_minio_data:/data
    healthcheck:
      test: ["CMD-SHELL", "curl -sf http://localhost:9000/minio/health/live || exit 1"]
      interval: 5s
      timeout: 3s
      retries: 5

  langfuse-web:
    image: docker.io/langfuse/langfuse:3
    profiles: ["observability", "full"]
    labels:
      com.quickstart.package: observability
    ports:
      - "3001:3000"
    depends_on:
      summit-cap-db:
        condition: service_healthy
      redis:
        condition: service_healthy
      clickhouse:
        condition: service_healthy
      minio:
        condition: service_healthy
    environment:
      <<: *langfuse-env
      HOSTNAME: "0.0.0.0"
    healthcheck:
      test: ["CMD-SHELL", "wget --spider -q http://127.0.0.1:3000/api/public/health || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s

  langfuse-worker:
    image: docker.io/langfuse/langfuse-worker:3
    profiles: ["observability", "full"]
    labels:
      com.quickstart.package: observability
    depends_on:
      summit-cap-db:
        condition: service_healthy
      redis:
        condition: service_healthy
      clickhouse:
        condition: service_healthy
      minio:
        condition: service_healthy
    environment:
      <<: *langfuse-env

volumes:
  summit_cap_postgres_data:
  langfuse_clickhouse_data:
  langfuse_clickhouse_logs:
  langfuse_minio_data:
